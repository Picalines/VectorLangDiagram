@using VectorLang
@using VectorLangDocs.Shared.DocumentationModel

@inject IJSRuntime JSRuntime
@inject NavigationManager NavigationManager

@typeparam TItem where TItem : DocumentationItem

<div id="viewer-root">
    <nav>
        <h3>Navigation</h3>
        @foreach (var item in Repository.Items)
        {
            <a href=@GetItemSelector(item)>@GetFormattedItemName(item)</a>
        }
    </nav>
    <div id="item-list">
        @foreach (var item in Repository.Items)
        {
            <article>
                @ItemHeader(item)

                @CopyLinkToItemButton(item)

                @item.Summary

                @if (item is ICallableDocumentationItem { ReturnValueInfo: var returnTypeInfo, Parameters: var parameters })
                {
                    if (returnTypeInfo is not null)
                    {
                        <section class="returns">
                            <h5>Returns</h5>
                            @returnTypeInfo
                        </section>
                    }

                    if (parameters.Any())
                    {
                        <section class="parameters">
                            <h5>Parameters</h5>
                            @foreach (var parameter in parameters)
                            {
                                <div>
                                    <span class="name">@parameter.Name</span>
                                    @LinkToTypeDocumentation(parameter.ParameterTypeDocumentaion)
                                    @if (parameter.Summary is { } summary)
                                    {
                                        <span class="summary">@summary</span>
                                    }
                                </div>
                            }
                        </section>
                    }
                }

                @if (item.UsageExample is not null)
                {
                    <pre>@CopyCodeButton(item.UsageExample)<code>@item.UsageExample</code></pre>
                }
            </article>
        }
    </div>
</div>

@code {
    [Parameter, EditorRequired]
    public DocumentationRepository<TItem> Repository { get; set; } = null!;

    private readonly Dictionary<TItem, string> _ItemHeaderIds = new();

    private string GetFormattedItemName(TItem item)
    {
        return item switch
        {
            InstanceUnaryOperatorDocumentation unaryOperator => unaryOperator.UnaryOperator.GetFormatted(unaryOperator.InstanceTypeDocumentation.Name),
            InstanceBinaryOperatorDocumentation binaryOperator => binaryOperator.BinaryOperator.GetFormatted(binaryOperator.LeftTypeDocumentation.Name, binaryOperator.RightTypeDocumentation.Name),
            IMemberDocumentationItem member => $"{member.InstanceTypeDocumentation.Name}.{item.Name}",
            _ => item.Name,
        };
    }

    private string GetItemHeaderId(TItem item)
    {
        if (_ItemHeaderIds.TryGetValue(item, out var id))
        {
            return id;
        }

        id = item switch
        {
            InstanceUnaryOperatorDocumentation unaryOperator => $"{unaryOperator.UnaryOperator}-{unaryOperator.InstanceTypeDocumentation.Name}",
            InstanceBinaryOperatorDocumentation binaryOperator => $"{binaryOperator.LeftTypeDocumentation.Name}-{binaryOperator.BinaryOperator}-{binaryOperator.RightTypeDocumentation.Name}",
            IMemberDocumentationItem member => $"{member.InstanceTypeDocumentation.Name}-{item.Name}",
            _ => item.Name,
        };

        return _ItemHeaderIds[item] = $"doc-{id.ToLower()}";
    }

    private string GetItemSelector(TItem item)
    {
        return "#" + GetItemHeaderId(item);
    }

    private RenderFragment LinkToTypeDocumentation(InstanceTypeDocumentation instanceType)
    {
        return @<a class="type-link" href="/type/@instanceType.Name">@instanceType.Name</a>;
    }

    private RenderFragment ItemHeader(TItem item)
    {
        return
    @<h4 id=@GetItemHeaderId(item) tabindex="-1">
        @switch (item)
        {
            case InstanceTypeDocumentation instanceTypeDocumentation:
            {
                @LinkToTypeDocumentation(instanceTypeDocumentation)
            }
            break;

            case ConstantDocumentation constantDocumentation:
            {
                <span>@item.Name: @LinkToTypeDocumentation(constantDocumentation.ConstantTypeDocumentation)</span>
            }
            break;

            case FunctionDocumentation functionDocumentation:
            {
                <span>@item.Name</span>
                <span>(@(string.Join(", ", functionDocumentation.Parameters.Items.Select(p => p.Name))))</span>
                <span> -> @LinkToTypeDocumentation(functionDocumentation.ReturnTypeDocumentation)</span>
            }
            break;

            case InstanceFieldDocumentation instanceFieldDocumentation:
            {
                @LinkToTypeDocumentation(instanceFieldDocumentation.InstanceTypeDocumentation)
                <span>.@item.Name</span>
                <span>: @LinkToTypeDocumentation(instanceFieldDocumentation.FieldTypeDocumentaion)</span>
            }
            break;

            case InstanceMethodDocumentation instanceMethodDocumentation:
            {
                @LinkToTypeDocumentation(instanceMethodDocumentation.InstanceTypeDocumentation)
                <span>.@item.Name</span>
                <span>(@(string.Join(", ", instanceMethodDocumentation.Parameters.Items.Select(p => p.Name))))</span>
                <span> -> @LinkToTypeDocumentation(instanceMethodDocumentation.ReturnTypeDocumentation)</span>
            }
            break;

            case InstanceUnaryOperatorDocumentation instanceUnaryOperatorDocumentation:
            {
                <span>@instanceUnaryOperatorDocumentation.UnaryOperator.GetDescription()</span>
                @LinkToTypeDocumentation(instanceUnaryOperatorDocumentation.InstanceTypeDocumentation)
                <span> -> @LinkToTypeDocumentation(instanceUnaryOperatorDocumentation.ReturnTypeDocumentation)</span>
            }
            break;

            case InstanceBinaryOperatorDocumentation instanceBinaryOperatorDocumentation:
            {
                @LinkToTypeDocumentation(instanceBinaryOperatorDocumentation.LeftTypeDocumentation)
                <span>@(" ")@(instanceBinaryOperatorDocumentation.BinaryOperator.GetDescription())@(" ")</span>
                @LinkToTypeDocumentation(instanceBinaryOperatorDocumentation.RightTypeDocumentation)
                <span> -> @LinkToTypeDocumentation(instanceBinaryOperatorDocumentation.ReturnTypeDocumentation)</span>
            }
            break;

            default:
                throw new NotImplementedException();
        }
    </h4>;
    }

    private RenderFragment CopyCodeButton(string code)
    {
        return @<button class="copy-button" title="Copy code" @onclick="() => CopyToClipboard(code)"><img src="./svg/copy-text-icon.svg" /></button>;
    }

    private RenderFragment CopyLinkToItemButton(TItem item)
    {
        var currentUri = NavigationManager.Uri;
        var idIndex = currentUri.IndexOf('#') is var index and not -1 ? index : currentUri.Length - 1;
        var link = currentUri.Substring(0, idIndex + 1) + GetItemSelector(item);
        return @<button class="copy-button" title="Copy link" @onclick="() => CopyToClipboard(link)"><img src="./svg/copy-link-icon.svg" /></button>;
    }

    private async void CopyToClipboard(string text)
    {
        await JSRuntime.InvokeVoidAsync("navigator.clipboard.writeText", text);
    }
}
